name: Deploy to AWS App Runner

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        run: |
          docker build -t 123823813021.dkr.ecr.us-east-1.amazonaws.com/skytunescsharp:latest .
          docker push 123823813021.dkr.ecr.us-east-1.amazonaws.com/skytunescsharp:latest

      - name: Trigger App Runner deployment
        run: |
          SERVICE_ARN=$(aws apprunner list-services --query "ServiceSummaryList[?ServiceName=='skytunescsharp'].ServiceArn" --output text)
          aws apprunner start-deployment --service-arn $SERVICE_ARN
          echo "üöÄ Deployment triggered! App Runner will now update with the new image."

      - name: Send deployment success email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Deployment Successful - SkyTunes CSharp"
          body: |
            Hello Milton,

            Your deployment to AWS App Runner has completed successfully! üéâ

            **Details:**
            - Repository: ${{ github.repository }}
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref }}
            - Triggered by: ${{ github.actor }}
            - Timestamp: ${{ github.event.head_commit.timestamp }}

            The new Docker image has been built, pushed to ECR, and App Runner deployment has been triggered.

            You can check your service status in the AWS App Runner console.

            Best regards,
            GitHub Actions ü§ñ
          to: miltonejones@gmail.com
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
        if: success()

      - name: Send deployment failure email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå Deployment Failed - SkyTunes CSharp"
          body: |
            Hello Milton,

            Your deployment to AWS App Runner has failed! ‚ö†Ô∏è

            **Details:**
            - Repository: ${{ github.repository }}
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref }}
            - Triggered by: ${{ github.actor }}

            Please check the GitHub Actions logs for details on what went wrong:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            You may need to investigate the build process, AWS credentials, or App Runner configuration.

            Best regards,
            GitHub Actions ü§ñ
          to: miltonejones@gmail.com
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
        if: failure()
